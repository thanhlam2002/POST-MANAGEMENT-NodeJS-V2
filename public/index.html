<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Post Management App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .container { width: 400px; margin: 50px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        form { display: flex; flex-direction: column; }
        input[type="text"], input[type="password"], input[type="file"] { margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px; border: none; background: #28a745; color: white; border-radius: 5px; cursor: pointer; }
        button:hover { background: #218838; }
        .posts { width: 80%; margin: 20px auto; }
        .post { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .post img { max-width: 100%; height: auto; border-radius: 5px; }
        .post-actions { margin-top: 10px; }
        .post-actions button { margin-right: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container" id="authContainer">
        <h1>Register</h1>
        <form id="registerForm">
            <input type="text" id="regUsername" placeholder="Username" required>
            <input type="password" id="regPassword" placeholder="Password" required>
            <button type="submit">Register</button>
        </form>

        <h1>Login</h1>
        <form id="loginForm">
            <input type="text" id="loginUsername" placeholder="Username">
            <input type="password" id="loginPassword" placeholder="Password">
            <button type="submit">Login</button>
        </form>
    </div>

    <div class="container hidden" id="postContainer">
        <h1>Create Post</h1>
        <form id="postForm">
            <input type="text" id="title" placeholder="Title">
            <input type="text" id="content" placeholder="Content">
            <input type="text" id="category" placeholder="Category">
            <input type="file" id="thumbnail">
            <button type="submit">Create Post</button>
        </form>
    </div>

    <div class="posts" id="postList"></div>

    <script>
        let token = "";
        let currentUserId = "";

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            alert(data.message);
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (res.ok) {
                token = data.token;
                currentUserId = parseJwt(token).id;
                document.getElementById('authContainer').classList.add('hidden');
                document.getElementById('postContainer').classList.remove('hidden');
                loadPosts();
            } else {
                alert(data.message);
            }
        });

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('content', document.getElementById('content').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('thumbnail', document.getElementById('thumbnail').files[0]);

            const res = await fetch('/api/posts', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const data = await res.text();
            alert(data);
            loadPosts();
        });

        async function loadPosts() {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            const postList = document.getElementById('postList');
            postList.innerHTML = '';
            posts.forEach(post => {
                const div = document.createElement('div');
                div.className = 'post';
                div.innerHTML = `
                    <h3>${post.title}</h3>
                    <p>${post.content}</p>
                    <img src="${post.thumbnail}" alt="Thumbnail">
                    <div class="post-actions">
                        ${post.author && post.author._id === currentUserId ? `
                            <button onclick="editPost('${post._id}')">Edit</button>
                            <button onclick="deletePost('${post._id}')">Delete</button>
                        ` : ''}
                    </div>
                `;
                postList.appendChild(div);
            });
        }

        async function editPost(postId) {
            const newTitle = prompt('New title:');
            const newContent = prompt('New content:');
            const res = await fetch(`/api/posts/${postId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ title: newTitle, content: newContent })
            });
            alert(await res.text());
            loadPosts();
        }

        async function deletePost(postId) {
            const res = await fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            alert(await res.text());
            loadPosts();
        }

        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
    </script>
</body>
</html>



